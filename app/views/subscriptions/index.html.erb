<div class="banner">
  <div class = "container">
    <div class="row bigmarge">
      <div class="col-xs-5">
        <h1 id="tournament-name"><%= @tournament.name.upcase %></h1>
      </div>
      <div class="col-xs-5">
        <%=link_to image_tag('fleche_droite.svg', class: 'fleche_subscription_index') + "Ajouter un joueur à la liste", new_tournament_player_invitation_path(@tournament), class: "btn btn-success", id: "convocation-submit" %>
        <%=link_to image_tag('fleche_droite.svg', class: 'fleche_subscription_index') + "Statistiques Tournoi", tournament_rankings_path(@tournament), class: "btn btn-success", id: "convocation-submit" %>
      </div>
    </div>

      <table id="example" class="table table-hover card display dataTable table_judge_tournoi">
          <thead>
            <tr>
             <th>Exporté</th>
             <th><input type="checkbox" onClick="toggle(this)" />Sélectionner tout</th>
             <th>Prénom</th>
             <th>Nom</th>
             <th>Licence</th>
             <th>Inscription</th>
             <th class="text-center">Profil</th>
             <th>Convocation en cours</th>
             <th>Messages</th>
             <th>Dispos</th>
            </tr>
          </thead>
          <tbody>
            <% @subscriptions.each do |subscription|%>
              <tr class="subscription_item" id="<%= subscription.id %>">
                <%if subscription.exported == true%>
                  <td><i class="fa fa-check-circle"></i></td>

                <%else%>
                  <td><i class="fa fa-times"></i></td>
                <% end -%>
                <%if subscription.status == "confirmed" || subscription.status == "confirmed!"%>
                  <td class="checkbox"><input class="checkbox-player" type="checkbox" name="foo"></td>
                <%else %>
                  <td></td>
                <%end%>
                <td class="first-name"><%= subscription.user.first_name%></td>
                <td><%= subscription.user.last_name%></td>
                <td><%= subscription.user.licence_number%></td>

                <%if subscription.status == "pending" %>
                  <td>
                    <%= form_for [@tournament, subscription] do |f| %>
                      <%= f.select :status, Subscription.status.options, class: "form-control subscription-status" %>
                    <%end%>
                  </td>
                <%elsif subscription.status == "confirmed"%>
                  <td>
                    <div class="btn btn-success">
                      <a href="#" data-target="#confirme" data-toggle="modal" class="subscription_status">
                        Confirmé
                      </a>
                    </div>
                    <div class="modal fade" id="confirme">
                      <div class="modal-dialog mymodal">
                        <div class="modal-content text-center">
                          <div class="modal-header">
                            <h4 class="modal-title">Remboursement</h4>
                             <p>Ce joueur ne participe plus au tournoi finalement ? Vous pouvez le supprimer et procéder au remboursement de ses frais d'inscription ! <br></p>
                             <p> Il vous suffit de cliquer sur <strong>Rembourser</strong> ci-dessous pour que son inscription au tournoi soit supprimé et lui reverser ses frais d'inscription</p>
                          </div>
                          <div class="modal-body">
                          <%= form_tag refund_subscription_path(subscription) do %>
                            <%= submit_tag "Rembourser ce joueur", id: "export", class: "btn btn-warning"%>
                          <% end -%>
                          </div>
                          <div class="modal-footer">
                          </div>
                        </div><!-- /.modal-content -->
                      </div><!-- /.modal-dialog -->
                    </div>
                    <%elsif subscription.status == "confirmed!"%>
                    <td>
                    <div class="btn btn-success">
                      <a href="#" data-target="#confirme_without" data-toggle="modal" class="subscription_status" id="confirm!">
                        !Confirmé!
                      </a>
                    </div>
                     <div id="parent">
                        <div id="popup_subscription_index" style="display: none"><strong>!CONFIRME!</strong> signifie que le joueur a bien été confirmé dans la compétition mais que son paiement n'a pas été pris en compte via WeTennis. <strong>Vous devrez donc encaissez le joueur le jour de sa première convocation.</strong></div>
                      </div>
                    <div class="modal fade" id="confirme_without">
                      <div class="modal-dialog mymodal">
                        <div class="modal-content text-center">
                          <div class="modal-header">
                            <h4 class="modal-title">Refuser ce joueur ?</h4>
                             <p>Ce joueur ne participe plus au tournoi finalement ? Il vous suffit simplement de cliquer ci-dessous pour annuler son inscription.<br></p>
                          </div>
                          <div class="modal-body">
                          <%= form_tag refuse_subscription_path(subscription) do %>
                            <%= submit_tag "Refuser ce joueur", class: "btn btn-warning"%>
                          <% end -%>
                          </div>
                          <div class="modal-footer">
                          </div>
                        </div><!-- /.modal-content -->
                      </div><!-- /.modal-dialog -->
                    </div>
                <%else%>
                  <td >
                     <div class="btn btn-danger">
                      <a href="#" data-target="#refuse" data-toggle="modal" class="subscription_status">
                        Refusé
                      </a>
                    </div>
                    <div class="modal fade" id="refuse">
                      <div class="modal-dialog mymodal">
                        <div class="modal-content text-center">
                          <div class="modal-header">
                            <h4 class="modal-title">Accepter ce joueur dans le tournoi finalement</h4>
                             <p>Vous voulez finalement laisser ce joueur participer au tournoi? Pas de problème !<br></p>
                             <p> Il vous suffit de cliquer sur <strong>Accepter ce joueur</strong> ci-dessous pour que son inscription au tournoi soit confirmée et commencer à lui envoyer des convocations</p><br>
                             <strong>ATTENTION !</strong><br>
                             <p>le paiement en ligne ne pourra pas passer par TennisMatch pour ce joueur et vous devrez l'encaissez vous-même</p>
                          </div>
                          <div class="modal-body">
                          <%= form_tag accept_subscription_path(subscription) do %>
                            <%= submit_tag "Confirmer ce Joueur", class: "btn btn-success"%>
                          <% end -%>
                          </div>
                          <div class="modal-footer">
                          </div>
                        </div><!-- /.modal-content -->
                      </div><!-- /.modal-dialog -->
                    </div>
                  </td>
                <% end %>

                <td><button type="button" class="btn btn-primary "><%=link_to "Profil", user_path(subscription.user) %></button></td>


                <% if subscription.convocations.last %>
                  <td><%= subscription.convocations.last.status_text %></td>
                <%else%>
                  <td></td>
                <% end %>

                <% if subscription.convocations.last && subscription.convocations.last.messages != [] %>
                <td>
                  <%=link_to "+1", convocation_messages_path(subscription.convocations.last), class: "btn btn-success" %>
                </td>
                <%else%>
                  <td></td>
                <% end %>
                <% if subscription.disponibility %>
                  <td>
                    <%= link_to image_tag("fleche_bleufonce.svg"), subscription_disponibility_path(subscription, subscription.disponibility), class: "fleche_subscription" %>
                  </td>
                <% else %>
                  <td>Non renseignées</td>
                <% end %>
              </tr>
            <%end%>
          </tbody>
        </table>

        <div class="row">
          <div class="col-xs-6">
            <%= form_tag multiple_new_path(@tournament) do %>
              <%= hidden_field_tag :select_players %>
              <%= submit_tag "Convoquer les joueurs sélectionnés", class: "btn btn-success margin" %>
            <% end %>

          </div>
          <div class="col-xs-offset-2 col-xs-2">
            <a href="#" data-target="#exporter" data-toggle="modal" class="btn btn-success convocation-answer"><%=image_tag('fleche_droite.svg', class: 'fleche_subscription_index')%>Exporter vers AEI</a>
            <div class="modal fade" id="exporter">
              <div class="modal-dialog mymodal">
                <div class="modal-content text-center">
                  <div class="modal-header">
                    <h4 class="modal-title">Exporter la liste de vos inscrits sur AEI</h4>
                     <p> Tennis-Match vous permet d'exporter la liste de tous vos inscrits sur AEI.Avant de continuer, assurer vous: <br></p>
                      <ul>
                        <li> <strong>D'avoir bien créer votre Tournoi sur AEI</strong></li>
                        <li> <strong>Que le numéro d'homologation sur AEI et TennisMatch correspondent</strong></li>
                        <li><strong>Que la catégorie du tournoi sur AEI et TennisMatch correspondent</strong></li>
                      </ul>
                  </div>
                  <div class="modal-body">

                    <%= form_tag tournament_aei_export_path(@tournament) do %>
                      <%= hidden_field_tag :subscription_ids_export %>
                      <%= label_tag :login_aei, "Identifiant AEI" %>
                      <%= text_field_tag(:login_aei) %>
                      <%= label_tag :password_aei, "Mot de passe AEI" %>
                      <%= text_field_tag(:password_aei) %>
                      <%= submit_tag "Exporter vos inscrits", id: "export", class: "btn btn-success margin"%>
                    <% end -%>
                  </div>
                  <div class="modal-footer">
                  </div>
                </div><!-- /.modal-content -->
              </div><!-- /.modal-dialog -->
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>
<!-- this js should use toggleclass -->
<%= content_for :after_js do %>
<script>
$(document).ready(function() {


  $('.checkbox-player').on('change', function() {
    var subscriptionIds = $('.checkbox-player:checked').map(function() {
      return $(this).parent().parent().prop('id');
    }).get().join(',');
    $('#select_players').val(subscriptionIds);
    $('#subscription_ids_export').val(subscriptionIds);
  })
})





$(document).ready( function () {
  $.fn.dataTableExt.oStdClasses["sFilter"] = "my-style-class";
  $('#example').DataTable({
    "paging": false,
    "ordering": false,
    "info":     false,

  });
});


function toggle(source) {
  checkboxes = document.getElementsByName('foo');
  for(var i=0, n=checkboxes.length;i<n;i++) {
    checkboxes[i].checked = source.checked;
  }
  var subscriptionIds = $('.checkbox-player:checked').map(function() {
      return $(this).parent().parent().prop('id');
    }).get().join(',');
  $('#select_players').val(subscriptionIds);
  $('#subscription_ids_export').val(subscriptionIds);
}

$(document).ready( function () {
  var e = document.getElementById('confirm!');
  e.onmouseover = function() {
    document.getElementById('popup_subscription_index').style.display = 'block';
  }
  e.onmouseout = function() {
    document.getElementById('popup_subscription_index').style.display = 'none';
  }
});

</script>
<% end %>
