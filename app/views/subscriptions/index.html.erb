<div class="banner">
  <div class = "container">
    <div class="row">
      <div class="col-xs-5">
        <h1 id="tournament-name"><%= @tournament.name %></h1>
        <form class="form-horizontal" id="algolia-bar">
          <div class="form-group">
            <input name="Tournament" placeholder="Cherchez un joueur par nom ou classement" id="tournament"/>
          </div>
        </form>
      </div>
      <div class="col-xs-5">
        <%=link_to "Ajouter un joueur à la liste", invite_player_path(@tournament), class: "btn btn-success", id: "convocation-submit" %>
      </div>
    </div>


    <table class="table table-hover card">
      <tr>
          <th>Select</th>
          <th>Prénom</th>
          <th>Nom</th>
          <th>Numéro de licence</th>
          <th>Status de l'inscription</th>
          <th>Convoquer ?</th>
          <th>Statut de la convocation en cours</th>
          <th>Messages<th>
      </tr>
      <% @subscriptions.each do |subscription|%>
        <tr class="subscription_item" id="<%= subscription.id %>">
          <td class="checkbox"><input id="checkbox-player" type="checkbox"></td>
          <td><%= subscription.user.first_name%></td>
          <td><%= subscription.user.last_name%></td>
          <td><%= subscription.user.licence_number%></td>
          <td>
            <%= form_for [@tournament, subscription] do |f| %>
              <%= f.select :status, Subscription.status.options, remote: true, class: "form-control subscription-status" %>
            <% end %>
           </td>
          <td><button type="button" class="btn btn-primary "><%=link_to "Profil du joueur", user_path(subscription.user) %></button></td>

          <td>
            <% if subscription.convocations.last %>
              <%= subscription.convocations.last.status_text %>
            <% end %>
          </td>

          <td>
            <% if subscription.convocations.last && subscription.convocations.last.messages != [] %>
              <%=link_to "+1", convocation_messages_path(subscription.convocations.last), class: "btn btn-success" %></td>
            <% end %>
        </tr>
     <%end%>
    </table>

    <%= form_tag multiple_new_path(@tournament) do %>
        <%= hidden_field_tag :subscription_ids %>
        <%= submit_tag "Convoquer les joueurs sélectionnés", class: "btn btn-success margin" %>
        <% end %>
  </div>
</div>

    <%= content_for :after_js do %>
      <% javascript_tag do %>
        $(document).ready(function() {
        var string = "";
          $('.checkbox').on('click', function() {
            var subscription_id = $(this).parent().attr('id');
            if(string == "") {
              string = subscription_id;
            } else {
              string = string + ", " + subscription_id;
            }
            $('#subscription_ids').val(string);
          })
        })
      <% end %>
    <% end %>

    <%= content_for :after_js do %>
      <% javascript_tag do %>
        $(document).ready(function() {
          $("#subscription-status").change(function(){
            $$.ajax({url: "/tournaments/:tournament_id/subscriptions/:id", type: "POST"};
            });
          });
        });
       <% end %>
    <% end %>

    <script type="text/javascript">


  $(document).ready(function() {
    var client = new AlgoliaSearch("<%=ENV["ALGOLIA_APPLICATION_ID"]%>", "<%=ENV["ALGOLIA_SEARCH_ONLY_API_KEY"]%>");
    var $facets = $('#facets');
    // var $facetTemplate = Hogan.compile($('#facet-template').text());
    // var $sliderTemplate = Hogan.compile($('#slider-template').text());

    // Helper initialization

    // var template = Hogan.compile('{{{_highlightResult.email.value}}} ({{{_highlightResult.first_name.value}}} {{{_highlightResult.last_name.value}}})');
    $('#tournament').typeahead(null, {
      source: client.initIndex('<%= Tournament.index_name %>').ttAdapter(),
      displayKey: 'name',
      templates: {
        suggestion: function(hit) {
          console.log(hit);
          return '<div class="result-item col-xs-12"><a href="/tournaments/' + hit.objectID + '">' +
              '<div class="col-xs-8">' +
                '<h5>' + hit._highlightResult.name.value + '</h5>' +
                '<p>' + hit._highlightResult.category.value + '</p>' +
                '<p>' + hit._highlightResult.genre.value + '</p>' +
              '</div>' +
              '<div class="col-xs-4">' +
                '<h5>' + 'du '+ hit._highlightResult.starts_on.value + ' au ' +hit._highlightResult.ends_on.value +
                '</h5>' +
              '</div>' +
              '<div class="col-xs-4">' +
                '<h5>' + hit._highlightResult.address.value + ' à ' +hit._highlightResult.city.value +
                '</h5>' +
              '</div>' +
           '</a>' +
          '</div>';
        }
      }
    });
  });

</script>






